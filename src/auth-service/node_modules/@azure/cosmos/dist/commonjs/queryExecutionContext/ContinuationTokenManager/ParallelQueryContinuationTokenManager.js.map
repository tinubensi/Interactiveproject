{"version":3,"file":"ParallelQueryContinuationTokenManager.js","sourceRoot":"","sources":["../../../../src/queryExecutionContext/ContinuationTokenManager/ParallelQueryContinuationTokenManager.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\n\nimport { BaseContinuationTokenManager } from \"./BaseContinuationTokenManager.js\";\nimport type { ParallelQueryResult } from \"../parallelQueryResult.js\";\nimport type {\n  CompositeQueryContinuationToken,\n  QueryRangeWithContinuationToken,\n} from \"../../documents/ContinuationToken/CompositeQueryContinuationToken.js\";\nimport {\n  createCompositeQueryContinuationToken,\n  serializeCompositeToken,\n  parseCompositeQueryContinuationToken,\n  convertRangeMappingToQueryRange,\n} from \"../../documents/ContinuationToken/CompositeQueryContinuationToken.js\";\nimport type { QueryRangeMapping } from \"../queryRangeMapping.js\";\n\n/**\n * Manages continuation tokens for parallel queries using multi-range aggregation.\n * Uses CompositeQueryContinuationToken for range tracking across multiple partitions.\n * @internal\n */\nexport class ParallelQueryContinuationTokenManager extends BaseContinuationTokenManager {\n  private continuationToken: CompositeQueryContinuationToken | undefined;\n  private readonly collectionLink: string;\n\n  constructor(collectionLink: string, initialContinuationToken?: string) {\n    super(initialContinuationToken);\n    this.collectionLink = collectionLink;\n    if (initialContinuationToken) {\n      this.continuationToken = parseCompositeQueryContinuationToken(initialContinuationToken);\n    }\n  }\n\n  protected processRangesForPagination(\n    pageSize: number,\n    _isResponseEmpty: boolean,\n  ): { endIndex: number; processedRanges: string[] } {\n    const result = this.partitionManager.processParallelRanges(pageSize);\n    if (!result || !result.processedRangeMappings || result.processedRangeMappings.length === 0) {\n      return { endIndex: 0, processedRanges: [] };\n    }\n\n    const rangeMappings: QueryRangeWithContinuationToken[] = result.processedRangeMappings.map(\n      (mapping: QueryRangeMapping) => convertRangeMappingToQueryRange(mapping),\n    );\n\n    if (!this.continuationToken) {\n      this.continuationToken = createCompositeQueryContinuationToken(\n        this.collectionLink,\n        rangeMappings,\n      );\n    } else {\n      this.updateExistingCompositeContinuationToken(rangeMappings);\n    }\n\n    if (result.lastPartitionBeforeCutoff && result.lastPartitionBeforeCutoff.mapping) {\n      this.continuationToken!.offset = result.lastPartitionBeforeCutoff.mapping.offset;\n      this.continuationToken!.limit = result.lastPartitionBeforeCutoff.mapping.limit;\n    }\n    return { endIndex: result.endIndex, processedRanges: result.processedRanges };\n  }\n\n  protected getCurrentContinuationToken(): CompositeQueryContinuationToken | undefined {\n    return this.continuationToken;\n  }\n\n  protected getSerializationFunction(): (token: CompositeQueryContinuationToken) => string {\n    return serializeCompositeToken;\n  }\n\n  protected processQuerySpecificResponse(_responseResult: ParallelQueryResult): void {\n    // Parallel queries don't need additional response processing\n  }\n\n  protected performQuerySpecificDataTrim(_processedRanges: string[], _endIndex: number): void {\n    // Parallel queries don't need additional cleanup\n  }\n\n  private updateExistingCompositeContinuationToken(\n    rangeMappings: QueryRangeWithContinuationToken[],\n  ): void {\n    for (const newRange of rangeMappings) {\n      // Check if this range already exists in the token\n      const existingRangeIndex = this.continuationToken!.rangeMappings.findIndex(\n        (existingRange) =>\n          existingRange.queryRange.min === newRange.queryRange.min &&\n          existingRange.queryRange.max === newRange.queryRange.max,\n      );\n\n      if (existingRangeIndex >= 0) {\n        // Range exists - update the continuation token\n        this.continuationToken!.rangeMappings[existingRangeIndex] = newRange;\n      } else {\n        // New range - add to the rangeMappings array\n        this.continuationToken!.rangeMappings.push(newRange);\n      }\n    }\n  }\n}\n"]}