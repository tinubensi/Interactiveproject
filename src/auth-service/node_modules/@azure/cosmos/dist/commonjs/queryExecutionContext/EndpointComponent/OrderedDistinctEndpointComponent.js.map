{"version":3,"file":"OrderedDistinctEndpointComponent.js","sourceRoot":"","sources":["../../../../src/queryExecutionContext/EndpointComponent/OrderedDistinctEndpointComponent.ts"],"names":[],"mappings":";;;AAIA,6DAAuD;AAEvD,sEAAgG;AAChG,sEAAkF;AAElF,cAAc;AACd,MAAa,gCAAgC;IAIjC;IAHF,gBAAgB,CAAS;IAEjC,YACU,gBAAkC,EAC1C,gBAAyB;QADjB,qBAAgB,GAAhB,gBAAgB,CAAkB;QAG1C,IAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAC;IAC3C,CAAC;IAEM,cAAc;QACnB,OAAO,IAAI,CAAC,gBAAgB,CAAC,cAAc,EAAE,CAAC;IAChD,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,cAAuC;QAC5D,MAAM,MAAM,GAAU,EAAE,CAAC;QACzB,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,SAAS,CAAC,cAAc,CAAC,CAAC;QACvE,IACE,CAAC,QAAQ;YACT,CAAC,QAAQ,CAAC,MAAM;YAChB,CAAC,KAAK,CAAC,OAAO,CAAC,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC;YACtC,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,MAAM,KAAK,CAAC,EACnC,CAAC;YACD,OAAO,EAAE,MAAM,EAAE,QAAQ,CAAC,MAAM,EAAE,OAAO,EAAE,QAAQ,CAAC,OAAO,EAAE,CAAC;QAChE,CAAC;QAED,MAAM,cAAc,GAAG,QAAQ,CAAC,MAA6B,CAAC;QAC9D,MAAM,aAAa,GAAU,cAAc,CAAC,MAAM,CAAC;QACnD,MAAM,oBAAoB,GAAG,cAAc,CAAC,oBAAoB,CAAC;QACjE,MAAM,yBAAyB,GAAG,cAAc,CAAC,yBAAyB,CAAC;QAC3E,MAAM,YAAY,GAAG,cAAc,CAAC,YAAY,CAAC;QAEjD,yEAAyE;QACzE,KAAK,MAAM,IAAI,IAAI,aAAa,EAAE,CAAC;YACjC,IAAI,IAAI,EAAE,CAAC;gBACT,MAAM,YAAY,GAAG,MAAM,IAAA,0BAAU,EAAC,IAAI,CAAC,CAAC;gBAC5C,IAAI,YAAY,KAAK,IAAI,CAAC,gBAAgB,EAAE,CAAC;oBAC3C,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;oBAClB,IAAI,CAAC,gBAAgB,GAAG,YAAY,CAAC;gBACvC,CAAC;YACH,CAAC;QACH,CAAC;QAED,wFAAwF;QACxF,MAAM,2BAA2B,GAAG,MAAM,IAAA,8DAAqC,EAC7E,aAAa,EACb,oBAAoB,EACpB,0BAAU,CACX,CAAC;QAEF,gEAAgE;QAChE,MAAM,MAAM,GAAG,IAAA,kDAAyB,EACtC,MAAM,EACN,2BAA2B,EAC3B,yBAAyB,EACzB,YAAY,CACb,CAAC;QAEF,OAAO;YACL,MAAM;YACN,OAAO,EAAE,QAAQ,CAAC,OAAO;SAC1B,CAAC;IACJ,CAAC;CACF;AA/DD,4EA+DC","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\nimport type { Response } from \"../../request/index.js\";\nimport type { ExecutionContext } from \"../ExecutionContext.js\";\nimport { hashObject } from \"../../utils/hashObject.js\";\nimport type { DiagnosticNodeInternal } from \"../../diagnostics/DiagnosticNodeInternal.js\";\nimport { createParallelQueryResult, type ParallelQueryResult } from \"../parallelQueryResult.js\";\nimport { processDistinctQueryAndUpdateRangeMap } from \"../PartitionRangeUtils.js\";\n\n/** @hidden */\nexport class OrderedDistinctEndpointComponent implements ExecutionContext {\n  private hashedLastResult: string;\n\n  constructor(\n    private executionContext: ExecutionContext,\n    hashedLastResult?: string,\n  ) {\n    this.hashedLastResult = hashedLastResult;\n  }\n\n  public hasMoreResults(): boolean {\n    return this.executionContext.hasMoreResults();\n  }\n\n  public async fetchMore(diagnosticNode?: DiagnosticNodeInternal): Promise<Response<any>> {\n    const buffer: any[] = [];\n    const response = await this.executionContext.fetchMore(diagnosticNode);\n    if (\n      !response ||\n      !response.result ||\n      !Array.isArray(response.result.buffer) ||\n      response.result.buffer.length === 0\n    ) {\n      return { result: response.result, headers: response.headers };\n    }\n\n    const parallelResult = response.result as ParallelQueryResult;\n    const dataToProcess: any[] = parallelResult.buffer;\n    const partitionKeyRangeMap = parallelResult.partitionKeyRangeMap;\n    const updatedContinuationRanges = parallelResult.updatedContinuationRanges;\n    const orderByItems = parallelResult.orderByItems;\n\n    // Process each item and maintain hashedLastResult for distinct filtering\n    for (const item of dataToProcess) {\n      if (item) {\n        const hashedResult = await hashObject(item);\n        if (hashedResult !== this.hashedLastResult) {\n          buffer.push(item);\n          this.hashedLastResult = hashedResult;\n        }\n      }\n    }\n\n    // Process distinct query logic and update partition key range map with hashedLastResult\n    const updatedPartitionKeyRangeMap = await processDistinctQueryAndUpdateRangeMap(\n      dataToProcess,\n      partitionKeyRangeMap,\n      hashObject,\n    );\n\n    // Return in the new structure format using the utility function\n    const result = createParallelQueryResult(\n      buffer,\n      updatedPartitionKeyRangeMap,\n      updatedContinuationRanges,\n      orderByItems,\n    );\n\n    return {\n      result,\n      headers: response.headers,\n    };\n  }\n}\n"]}