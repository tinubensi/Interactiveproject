{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "workflowDefinition.schema.json",
  "title": "Workflow Definition",
  "description": "Schema for validating workflow definitions",
  "type": "object",
  "required": ["name", "organizationId"],
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique document ID"
    },
    "workflowId": {
      "type": "string",
      "description": "Business workflow identifier"
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 200,
      "description": "Human-readable workflow name"
    },
    "description": {
      "type": "string",
      "maxLength": 2000,
      "description": "Workflow description"
    },
    "version": {
      "type": "integer",
      "minimum": 1,
      "description": "Workflow version number"
    },
    "status": {
      "type": "string",
      "enum": ["draft", "active", "inactive", "deprecated"],
      "default": "draft"
    },
    "organizationId": {
      "type": "string",
      "minLength": 1,
      "description": "Organization that owns this workflow"
    },
    "triggers": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/triggerDefinition"
      },
      "description": "Workflow triggers"
    },
    "steps": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/workflowStep"
      },
      "description": "Workflow steps"
    },
    "variables": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/variableDefinition"
      },
      "description": "Workflow variable definitions"
    },
    "settings": {
      "$ref": "#/definitions/workflowSettings"
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "category": {
      "type": "string"
    },
    "createdAt": {
      "type": "string",
      "format": "date-time"
    },
    "createdBy": {
      "type": "string"
    },
    "updatedAt": {
      "type": "string",
      "format": "date-time"
    },
    "updatedBy": {
      "type": "string"
    },
    "activatedAt": {
      "type": "string",
      "format": "date-time"
    },
    "activatedBy": {
      "type": "string"
    },
    "isDeleted": {
      "type": "boolean",
      "default": false
    }
  },
  "definitions": {
    "triggerDefinition": {
      "type": "object",
      "required": ["id", "type", "config"],
      "properties": {
        "id": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": ["event", "http", "schedule", "manual"]
        },
        "config": {
          "type": "object"
        },
        "isActive": {
          "type": "boolean",
          "default": true
        }
      }
    },
    "workflowStep": {
      "type": "object",
      "required": ["id", "name", "type", "order"],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200
        },
        "type": {
          "type": "string",
          "enum": [
            "action",
            "decision",
            "parallel",
            "wait",
            "loop",
            "human",
            "subworkflow",
            "transform",
            "script",
            "setVariable",
            "delay",
            "retry",
            "compensate",
            "terminate"
          ]
        },
        "order": {
          "type": "integer",
          "minimum": 0
        },
        "description": {
          "type": "string"
        },
        "isEnabled": {
          "type": "boolean",
          "default": true
        },
        "action": {
          "$ref": "#/definitions/stepAction"
        },
        "conditions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/transitionRule"
          }
        },
        "parallelConfig": {
          "$ref": "#/definitions/parallelConfig"
        },
        "waitConfig": {
          "$ref": "#/definitions/waitConfig"
        },
        "loopConfig": {
          "$ref": "#/definitions/loopConfig"
        },
        "scriptConfig": {
          "$ref": "#/definitions/scriptConfig"
        },
        "transformConfig": {
          "$ref": "#/definitions/transformConfig"
        },
        "subworkflowConfig": {
          "$ref": "#/definitions/subworkflowConfig"
        },
        "setVariables": {
          "type": "object"
        },
        "outputVariable": {
          "type": "string"
        },
        "delaySeconds": {
          "type": "integer",
          "minimum": 0
        },
        "transitions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/transitionRule"
          }
        },
        "onError": {
          "$ref": "#/definitions/errorHandler"
        },
        "compensation": {
          "type": "object"
        },
        "timeout": {
          "type": "integer",
          "minimum": 0
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "metadata": {
          "type": "object"
        }
      }
    },
    "stepAction": {
      "type": "object",
      "required": ["type", "config"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "http_request",
            "publish_event",
            "send_command",
            "cosmos_query",
            "cosmos_upsert",
            "cosmos_delete",
            "send_notification",
            "call_function"
          ]
        },
        "config": {
          "type": "object"
        },
        "outputVariable": {
          "type": "string"
        }
      }
    },
    "transitionRule": {
      "type": "object",
      "required": ["targetStepId"],
      "properties": {
        "targetStepId": {
          "type": "string"
        },
        "condition": {
          "$ref": "#/definitions/conditionExpression"
        },
        "isDefault": {
          "type": "boolean"
        },
        "priority": {
          "type": "integer"
        }
      }
    },
    "conditionExpression": {
      "oneOf": [
        {
          "type": "object",
          "required": ["left", "operator", "right"],
          "properties": {
            "left": {
              "type": "string"
            },
            "operator": {
              "type": "string",
              "enum": [
                "eq",
                "neq",
                "gt",
                "gte",
                "lt",
                "lte",
                "contains",
                "startsWith",
                "endsWith",
                "in",
                "notIn",
                "exists",
                "notExists",
                "regex"
              ]
            },
            "right": {}
          }
        },
        {
          "type": "object",
          "required": ["operator", "conditions"],
          "properties": {
            "operator": {
              "type": "string",
              "enum": ["and", "or"]
            },
            "conditions": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/conditionExpression"
              }
            }
          }
        },
        {
          "type": "object",
          "required": ["operator", "condition"],
          "properties": {
            "operator": {
              "type": "string",
              "enum": ["not"]
            },
            "condition": {
              "$ref": "#/definitions/conditionExpression"
            }
          }
        }
      ]
    },
    "parallelConfig": {
      "type": "object",
      "required": ["branches", "joinCondition"],
      "properties": {
        "branches": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "steps"],
            "properties": {
              "id": {
                "type": "string"
              },
              "name": {
                "type": "string"
              },
              "steps": {
                "type": "array",
                "items": {
                  "$ref": "#/definitions/workflowStep"
                }
              }
            }
          }
        },
        "joinCondition": {
          "type": "string",
          "enum": ["all", "any", "n-of-m"]
        },
        "joinCount": {
          "type": "integer",
          "minimum": 1
        },
        "timeout": {
          "type": "integer"
        },
        "continueOnBranchFailure": {
          "type": "boolean"
        }
      }
    },
    "waitConfig": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "eventType"],
          "properties": {
            "type": {
              "const": "event"
            },
            "eventType": {
              "type": "string"
            },
            "eventFilter": {
              "type": "string"
            },
            "extractVariables": {
              "type": "object"
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "durationSeconds"],
          "properties": {
            "type": {
              "const": "timeout"
            },
            "durationSeconds": {
              "type": "integer",
              "minimum": 0
            }
          }
        },
        {
          "type": "object",
          "required": ["type"],
          "properties": {
            "type": {
              "const": "approval"
            },
            "approverRoles": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "approverUsers": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "requiredApprovals": {
              "type": "integer",
              "minimum": 1
            },
            "escalationAfterSeconds": {
              "type": "integer"
            },
            "escalateTo": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        }
      ]
    },
    "loopConfig": {
      "type": "object",
      "required": ["collection", "itemVariable", "steps"],
      "properties": {
        "collection": {
          "type": "string"
        },
        "itemVariable": {
          "type": "string"
        },
        "indexVariable": {
          "type": "string"
        },
        "maxIterations": {
          "type": "integer",
          "minimum": 1
        },
        "parallelism": {
          "type": "integer",
          "minimum": 1
        },
        "steps": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/workflowStep"
          }
        },
        "breakCondition": {
          "$ref": "#/definitions/conditionExpression"
        }
      }
    },
    "scriptConfig": {
      "type": "object",
      "required": ["code"],
      "properties": {
        "code": {
          "type": "string"
        },
        "timeout": {
          "type": "integer",
          "minimum": 100,
          "maximum": 30000
        },
        "allowedGlobals": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "transformConfig": {
      "type": "object",
      "required": ["expression", "outputVariable"],
      "properties": {
        "expression": {
          "type": "string"
        },
        "outputVariable": {
          "type": "string"
        }
      }
    },
    "subworkflowConfig": {
      "type": "object",
      "required": ["workflowId"],
      "properties": {
        "workflowId": {
          "type": "string"
        },
        "version": {
          "type": "integer"
        },
        "inputMapping": {
          "type": "object"
        },
        "outputMapping": {
          "type": "object"
        },
        "waitForCompletion": {
          "type": "boolean",
          "default": true
        }
      }
    },
    "errorHandler": {
      "type": "object",
      "required": ["action"],
      "properties": {
        "action": {
          "type": "string",
          "enum": ["retry", "skip", "fail", "goto", "compensate"]
        },
        "retryPolicy": {
          "$ref": "#/definitions/retryPolicy"
        },
        "fallbackStepId": {
          "type": "string"
        },
        "compensationStepId": {
          "type": "string"
        }
      }
    },
    "retryPolicy": {
      "type": "object",
      "required": ["maxAttempts", "backoffType", "initialDelaySeconds"],
      "properties": {
        "maxAttempts": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10
        },
        "backoffType": {
          "type": "string",
          "enum": ["fixed", "exponential"]
        },
        "initialDelaySeconds": {
          "type": "integer",
          "minimum": 1
        },
        "maxDelaySeconds": {
          "type": "integer"
        },
        "retryableErrors": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "variableDefinition": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["string", "number", "boolean", "object", "array", "date"]
        },
        "defaultValue": {},
        "description": {
          "type": "string"
        },
        "required": {
          "type": "boolean"
        },
        "validation": {
          "type": "object",
          "properties": {
            "pattern": {
              "type": "string"
            },
            "min": {
              "type": "number"
            },
            "max": {
              "type": "number"
            },
            "enum": {
              "type": "array"
            }
          }
        }
      }
    },
    "workflowSettings": {
      "type": "object",
      "properties": {
        "maxExecutionDurationSeconds": {
          "type": "integer",
          "minimum": 60
        },
        "allowParallelExecutions": {
          "type": "boolean"
        },
        "maxParallelExecutions": {
          "type": "integer",
          "minimum": 1
        },
        "executionRetentionDays": {
          "type": "integer",
          "minimum": 1,
          "maximum": 365
        },
        "notifyOnFailure": {
          "type": "array",
          "items": {
            "type": "string",
            "format": "email"
          }
        },
        "notifyOnCompletion": {
          "type": "array",
          "items": {
            "type": "string",
            "format": "email"
          }
        },
        "enableAuditLogging": {
          "type": "boolean"
        },
        "enableMetrics": {
          "type": "boolean"
        }
      }
    }
  }
}

