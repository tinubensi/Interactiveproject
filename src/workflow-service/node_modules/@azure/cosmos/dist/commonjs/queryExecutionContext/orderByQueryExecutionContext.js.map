{"version":3,"file":"orderByQueryExecutionContext.js","sourceRoot":"","sources":["../../../src/queryExecutionContext/orderByQueryExecutionContext.ts"],"names":[],"mappings":";;;AASA,iGAA2F;AAC3F,iGAA2F;AAE3F,4GAAsG;AACtG,mHAA6G;AAE7G,cAAc;AACd,MAAa,4BACX,SAAQ,wEAAiC;IAGzC;;;;;;;;;;;;OAYG;IACH,YACE,aAA4B,EAC5B,cAAsB,EACtB,KAA4B,EAC5B,OAAoB,EACpB,6BAA4D,EAC5D,oBAA4B;QAE5B,MAAM,YAAY,GAAG,4DAA2B,CAAC,qBAAqB,CAAC;YACrE,SAAS,EAAE,6BAA6B;SACzC,CAAC,CAAC;QAEH,4DAA4D;QAC5D,MAAM,kBAAkB,GAAG,IAAI,kEAA8B,CAC3D,6BAA6B,CAAC,SAAS,CAAC,OAAO,CAChD,CAAC;QAEF,4FAA4F;QAC5F,MAAM,iBAAiB,GAAG,IAAI,wEAAiC,CAC7D,6BAA6B,CAAC,SAAS,CAAC,OAAO,CAChD,CAAC;QAEF,kDAAkD;QAClD,MAAM,UAAU,GAAG,CAAC,QAA0B,EAAE,QAA0B,EAAU,EAAE;YACpF,OAAO,iBAAiB,CAAC,OAAO,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;QACvD,CAAC,CAAC;QAEF,oCAAoC;QACpC,KAAK,CACH,aAAa,EACb,cAAc,EACd,KAAK,EACL,OAAO,EACP,6BAA6B,EAC7B,oBAAoB,EACpB,YAAY,EACZ,kBAAkB,EAClB,UAAU,CACX,CAAC;IACJ,CAAC;IAED;;OAEG;IACO,KAAK,CAAC,iBAAiB,CAAC,QAA0B;QAC1D,MAAM,QAAQ,GAAG,MAAM,QAAQ,CAAC,aAAa,EAAE,CAAC;QAChD,IAAI,QAAQ,IAAI,QAAQ,CAAC,MAAM,EAAE,CAAC;YAChC,OAAO;gBACL,MAAM,EAAE,CAAC,QAAQ,CAAC,MAAM,CAAC;gBACzB,OAAO,EAAE,QAAQ,CAAC,OAAO;aAC1B,CAAC;QACJ,CAAC;QACD,OAAO,QAAQ,CAAC;IAClB,CAAC;IAED;;;;;OAKG;IACO,8BAA8B,CAAC,oBAA6B;QACpE,iFAAiF;QACjF,OAAO,oBAAoB,CAAC;IAC9B,CAAC;CACF;AAlFD,oEAkFC","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\nimport type { ClientContext } from \"../ClientContext.js\";\nimport type { PartitionedQueryExecutionInfo } from \"../request/ErrorResponse.js\";\nimport type { FeedOptions } from \"../request/FeedOptions.js\";\nimport type { DocumentProducer } from \"./documentProducer.js\";\nimport type { ExecutionContext } from \"./ExecutionContext.js\";\nimport type { Response } from \"../request/index.js\";\n\nimport { OrderByDocumentProducerComparator } from \"./orderByDocumentProducerComparator.js\";\nimport { ParallelQueryExecutionContextBase } from \"./parallelQueryExecutionContextBase.js\";\nimport type { SqlQuerySpec } from \"./SqlQuerySpec.js\";\nimport { TargetPartitionRangeManager } from \"./queryFilteringStrategy/TargetPartitionRangeManager.js\";\nimport { OrderByQueryProcessingStrategy } from \"./queryProcessingStrategy/OrderByQueryProcessingStrategy.js\";\n\n/** @hidden */\nexport class OrderByQueryExecutionContext\n  extends ParallelQueryExecutionContextBase\n  implements ExecutionContext\n{\n  /**\n   * Provides the OrderByQueryExecutionContext.\n   * This class is capable of handling orderby queries and dervives from ParallelQueryExecutionContextBase.\n   *\n   * When handling a parallelized query, it instantiates one instance of\n   * DocumentProcuder per target partition key range and aggregates the result of each.\n   *\n   * @param clientContext - The service endpoint to use to create the client.\n   * @param collectionLink - The Collection Link\n   * @param options - Represents the feed options.\n   * @param partitionedQueryExecutionInfo - PartitionedQueryExecutionInfo\n   * @hidden\n   */\n  constructor(\n    clientContext: ClientContext,\n    collectionLink: string,\n    query: string | SqlQuerySpec,\n    options: FeedOptions,\n    partitionedQueryExecutionInfo: PartitionedQueryExecutionInfo,\n    correlatedActivityId: string,\n  ) {\n    const rangeManager = TargetPartitionRangeManager.createForOrderByQuery({\n      queryInfo: partitionedQueryExecutionInfo,\n    });\n\n    // Create ORDER BY query processing strategy with sortOrders\n    const processingStrategy = new OrderByQueryProcessingStrategy(\n      partitionedQueryExecutionInfo.queryInfo.orderBy,\n    );\n\n    // Create ORDER BY comparator (need to access sortOrders from partitionedQueryExecutionInfo)\n    const orderByComparator = new OrderByDocumentProducerComparator(\n      partitionedQueryExecutionInfo.queryInfo.orderBy,\n    );\n\n    // Create comparator function for ORDER BY queries\n    const comparator = (docProd1: DocumentProducer, docProd2: DocumentProducer): number => {\n      return orderByComparator.compare(docProd1, docProd2);\n    };\n\n    // Calling on base class constructor\n    super(\n      clientContext,\n      collectionLink,\n      query,\n      options,\n      partitionedQueryExecutionInfo,\n      correlatedActivityId,\n      rangeManager,\n      processingStrategy,\n      comparator,\n    );\n  }\n\n  /**\n   * Fetches next single item from producer for ORDER BY processing.\n   */\n  protected async fetchFromProducer(producer: DocumentProducer): Promise<Response<any>> {\n    const response = await producer.fetchNextItem();\n    if (response && response.result) {\n      return {\n        result: [response.result],\n        headers: response.headers,\n      };\n    }\n    return response;\n  }\n\n  /**\n   * Determines if buffered producers should continue to be processed for ORDER BY queries.\n   * For ORDER BY, only process when no unfilled producers remain to maintain order.\n   * @param isUnfilledQueueEmpty - Whether the unfilled queue is empty\n   * @hidden\n   */\n  protected shouldProcessBufferedProducers(isUnfilledQueueEmpty: boolean): boolean {\n    // For ORDER BY, only process when no unfilled producers remain to maintain order\n    return isUnfilledQueueEmpty;\n  }\n}\n"]}