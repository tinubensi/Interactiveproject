{"version":3,"file":"pipelinedQueryExecutionContext.js","sourceRoot":"","sources":["../../../src/queryExecutionContext/pipelinedQueryExecutionContext.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\nimport type { ClientContext } from \"../ClientContext.js\";\nimport type { Response, FeedOptions } from \"../request/index.js\";\nimport type { PartitionedQueryExecutionInfo, QueryInfo } from \"../request/ErrorResponse.js\";\nimport { ErrorResponse } from \"../request/ErrorResponse.js\";\nimport { OffsetLimitEndpointComponent } from \"./EndpointComponent/OffsetLimitEndpointComponent.js\";\nimport { OrderByEndpointComponent } from \"./EndpointComponent/OrderByEndpointComponent.js\";\nimport { OrderedDistinctEndpointComponent } from \"./EndpointComponent/OrderedDistinctEndpointComponent.js\";\nimport { UnorderedDistinctEndpointComponent } from \"./EndpointComponent/UnorderedDistinctEndpointComponent.js\";\nimport { GroupByEndpointComponent } from \"./EndpointComponent/GroupByEndpointComponent.js\";\nimport type { ExecutionContext } from \"./ExecutionContext.js\";\nimport { OrderByQueryExecutionContext } from \"./orderByQueryExecutionContext.js\";\nimport { ParallelQueryExecutionContext } from \"./parallelQueryExecutionContext.js\";\nimport { GroupByValueEndpointComponent } from \"./EndpointComponent/GroupByValueEndpointComponent.js\";\nimport type { SqlQuerySpec } from \"./SqlQuerySpec.js\";\nimport type { DiagnosticNodeInternal } from \"../diagnostics/DiagnosticNodeInternal.js\";\nimport { NonStreamingOrderByDistinctEndpointComponent } from \"./EndpointComponent/NonStreamingOrderByDistinctEndpointComponent.js\";\nimport { NonStreamingOrderByEndpointComponent } from \"./EndpointComponent/NonStreamingOrderByEndpointComponent.js\";\nimport {\n  rejectContinuationTokenForUnsupportedQueries,\n  QueryTypes,\n} from \"./QueryValidationHelper.js\";\nimport { parseContinuationTokenFields } from \"./ContinuationTokenParser.js\";\nimport { LegacyFetchImplementation } from \"./LegacyFetchImplementation.js\";\nimport { QueryControlFetchImplementation } from \"./QueryControlFetchImplementation.js\";\nimport { QueryExecution } from \"../common/constants.js\";\n\n/** @hidden */\nexport class PipelinedQueryExecutionContext implements ExecutionContext {\n  private fetchBuffer: any[];\n  private endpoint: ExecutionContext;\n  private readonly fetchImplementation: LegacyFetchImplementation | QueryControlFetchImplementation;\n\n  constructor(\n    private clientContext: ClientContext,\n    private collectionLink: string,\n    private query: string | SqlQuerySpec,\n    private options: FeedOptions,\n    private partitionedQueryExecutionInfo: PartitionedQueryExecutionInfo,\n    correlatedActivityId: string,\n    private emitRawOrderByPayload: boolean = false,\n  ) {\n    // Validate that queryInfo is present in partitioned query execution info\n    if (!partitionedQueryExecutionInfo.queryInfo) {\n      throw new ErrorResponse(\n        \"Query execution requires valid query plan information. \" +\n          \"The partitioned query execution info is missing queryInfo. \" +\n          \"This may indicate an invalid query or a problem with query planning.\",\n      );\n    }\n\n    if (!this.options.maxItemCount) {\n      this.options.maxItemCount = QueryExecution.DEFAULT_PAGE_SIZE;\n    }\n    const pageSize = this.options.maxItemCount;\n\n    // Extract query information and characteristics\n    const analyzedQueryInfo = this.analyzeQueryInfo(partitionedQueryExecutionInfo.queryInfo);\n    const {\n      sortOrders,\n      nonStreamingOrderBy,\n      isOrderByQuery,\n      isGroupByQuery,\n      isUnorderedDistinctQuery,\n      querySupportsTokens,\n    } = analyzedQueryInfo;\n\n    // Reject continuation token usage for unsupported query types\n    if (!querySupportsTokens) {\n      rejectContinuationTokenForUnsupportedQueries(this.options.continuationToken, [\n        QueryTypes.nonStreamingOrderBy(nonStreamingOrderBy),\n        QueryTypes.groupBy(isGroupByQuery),\n        QueryTypes.unorderedDistinct(isUnorderedDistinctQuery),\n      ]);\n    }\n\n    // Parse continuation token fields once for reuse in pipeline construction\n    const queryContinuationFields = this.options.continuationToken\n      ? parseContinuationTokenFields(this.options.continuationToken)\n      : undefined;\n\n    // Pick between non-streaming vs streaming execution context\n    this.endpoint = nonStreamingOrderBy\n      ? this.createNonStreamingEndpoint(\n          partitionedQueryExecutionInfo,\n          sortOrders,\n          correlatedActivityId,\n          options,\n        )\n      : this.createStreamingEndpoint(\n          partitionedQueryExecutionInfo,\n          sortOrders,\n          correlatedActivityId,\n          isGroupByQuery,\n          queryContinuationFields,\n        );\n    this.fetchBuffer = [];\n    // Initialize the appropriate fetch implementation based on enableQueryControl\n    if (this.options.enableQueryControl) {\n      this.fetchImplementation = new QueryControlFetchImplementation(\n        this.endpoint,\n        pageSize,\n        this.collectionLink,\n        this.options.continuationToken,\n        isOrderByQuery,\n        querySupportsTokens,\n      );\n    } else {\n      this.fetchImplementation = new LegacyFetchImplementation(this.endpoint, pageSize);\n    }\n  }\n\n  public hasMoreResults(): boolean {\n    return this.fetchBuffer.length !== 0 || this.endpoint.hasMoreResults();\n  }\n\n  public async fetchMore(diagnosticNode: DiagnosticNodeInternal): Promise<Response<any>> {\n    return this.fetchImplementation.fetchMore(diagnosticNode, this.fetchBuffer);\n  }\n\n  /**\n   * Creates a non-streaming endpoint for vector search and similar queries that require buffering\n   */\n  private createNonStreamingEndpoint(\n    partitionedQueryExecutionInfo: PartitionedQueryExecutionInfo,\n    sortOrders: any[],\n    correlatedActivityId: string,\n    options: FeedOptions,\n  ): ExecutionContext {\n    const queryInfo = partitionedQueryExecutionInfo.queryInfo!; // Safe to use ! after validation in constructor\n\n    if (!options.allowUnboundedNonStreamingQueries) {\n      this.checkQueryConstraints(queryInfo);\n    }\n\n    const vectorSearchBufferSize = this.calculateVectorSearchBufferSize(queryInfo, options);\n\n    this.validateVectorSearchBufferSize(vectorSearchBufferSize, options);\n\n    const baseContext = new ParallelQueryExecutionContext(\n      this.clientContext,\n      this.collectionLink,\n      this.query,\n      this.options,\n      this.partitionedQueryExecutionInfo,\n      correlatedActivityId,\n    );\n\n    return this.wrapWithNonStreamingComponent(\n      baseContext,\n      queryInfo,\n      sortOrders,\n      vectorSearchBufferSize,\n    );\n  }\n\n  /**\n   * Creates a streaming endpoint with proper pipeline components\n   */\n  private createStreamingEndpoint(\n    partitionedQueryExecutionInfo: PartitionedQueryExecutionInfo,\n    sortOrders: any[],\n    correlatedActivityId: string,\n    isGroupByQuery: boolean,\n    queryContinuationFields: any,\n  ): ExecutionContext {\n    const queryInfo = partitionedQueryExecutionInfo.queryInfo!; // Safe to use ! after validation in constructor\n\n    // Create base execution context\n    let endpoint = this.createBaseExecutionContext(\n      partitionedQueryExecutionInfo,\n      sortOrders,\n      correlatedActivityId,\n    );\n\n    // Apply pipeline transformations\n    endpoint = this.applyGroupByComponents(endpoint, queryInfo, isGroupByQuery);\n    endpoint = this.applyDistinctComponents(endpoint, queryInfo, queryContinuationFields);\n    endpoint = this.applyLimitComponents(endpoint, queryInfo, queryContinuationFields);\n\n    return endpoint;\n  }\n\n  /**\n   * Creates the base execution context (OrderBy or Parallel)\n   */\n  private createBaseExecutionContext(\n    partitionedQueryExecutionInfo: PartitionedQueryExecutionInfo,\n    sortOrders: any[],\n    correlatedActivityId: string,\n  ): ExecutionContext {\n    if (Array.isArray(sortOrders) && sortOrders.length > 0) {\n      // OrderBy queries need special wrapping for payload structure\n      return new OrderByEndpointComponent(\n        new OrderByQueryExecutionContext(\n          this.clientContext,\n          this.collectionLink,\n          this.query,\n          this.options,\n          partitionedQueryExecutionInfo,\n          correlatedActivityId,\n        ),\n        this.emitRawOrderByPayload,\n      );\n    }\n\n    // Parallel queries\n    return new ParallelQueryExecutionContext(\n      this.clientContext,\n      this.collectionLink,\n      this.query,\n      this.options,\n      partitionedQueryExecutionInfo,\n      correlatedActivityId,\n    );\n  }\n\n  /**\n   * Wraps base context with appropriate non-streaming component\n   */\n  private wrapWithNonStreamingComponent(\n    baseContext: ExecutionContext,\n    queryInfo: QueryInfo,\n    sortOrders: any[],\n    vectorSearchBufferSize: number,\n  ): ExecutionContext {\n    const distinctType = queryInfo.distinctType;\n\n    if (distinctType === \"None\") {\n      return new NonStreamingOrderByEndpointComponent(\n        baseContext,\n        sortOrders,\n        vectorSearchBufferSize,\n        queryInfo.offset,\n        this.emitRawOrderByPayload,\n      );\n    }\n\n    return new NonStreamingOrderByDistinctEndpointComponent(\n      baseContext,\n      queryInfo,\n      vectorSearchBufferSize,\n      this.emitRawOrderByPayload,\n    );\n  }\n\n  /**\n   * Applies GROUP BY components to the pipeline if needed\n   */\n  private applyGroupByComponents(\n    endpoint: ExecutionContext,\n    queryInfo: QueryInfo,\n    isGroupByQuery: boolean,\n  ): ExecutionContext {\n    if (!isGroupByQuery) {\n      return endpoint;\n    }\n\n    return queryInfo.hasSelectValue\n      ? new GroupByValueEndpointComponent(endpoint, queryInfo)\n      : new GroupByEndpointComponent(endpoint, queryInfo);\n  }\n\n  /**\n   * Applies DISTINCT components to the pipeline if needed\n   */\n  private applyDistinctComponents(\n    endpoint: ExecutionContext,\n    queryInfo: QueryInfo,\n    queryContinuationFields: any,\n  ): ExecutionContext {\n    const distinctType = queryInfo.distinctType;\n\n    if (distinctType === \"Ordered\") {\n      const lastHash = queryContinuationFields?.hashedLastResult;\n      return new OrderedDistinctEndpointComponent(endpoint, lastHash);\n    }\n\n    if (distinctType === \"Unordered\") {\n      return new UnorderedDistinctEndpointComponent(endpoint);\n    }\n\n    return endpoint;\n  }\n\n  /**\n   * Applies TOP and OFFSET+LIMIT components to the pipeline if needed\n   */\n  private applyLimitComponents(\n    endpoint: ExecutionContext,\n    queryInfo: QueryInfo,\n    queryContinuationFields: any,\n  ): ExecutionContext {\n    // Apply TOP component (TOP N is effectively OFFSET 0 LIMIT N)\n    let top = queryInfo.top;\n    if (typeof top === \"number\") {\n      if (queryContinuationFields?.limit !== undefined) {\n        top = queryContinuationFields.limit;\n      }\n      endpoint = new OffsetLimitEndpointComponent(endpoint, 0, top);\n    }\n\n    // Apply OFFSET+LIMIT component\n    let limit = queryInfo.limit;\n    let offset = queryInfo.offset;\n\n    if (queryContinuationFields) {\n      if (queryContinuationFields.limit !== undefined) {\n        limit = queryContinuationFields.limit;\n      }\n      if (queryContinuationFields.offset !== undefined) {\n        offset = queryContinuationFields.offset;\n      }\n    }\n\n    if (typeof limit === \"number\" && typeof offset === \"number\") {\n      endpoint = new OffsetLimitEndpointComponent(endpoint, offset, limit);\n    }\n\n    return endpoint;\n  }\n\n  /**\n   * Validates vector search buffer size constraints\n   */\n  private validateVectorSearchBufferSize(\n    vectorSearchBufferSize: number,\n    options: FeedOptions,\n  ): void {\n    const maxBufferSize = options[\"vectorSearchBufferSize\"]\n      ? options[\"vectorSearchBufferSize\"]\n      : QueryExecution.DEFAULT_MAX_VECTOR_SEARCH_BUFFER_SIZE;\n\n    if (vectorSearchBufferSize > maxBufferSize) {\n      throw new ErrorResponse(\n        `Executing a vector search query with TOP or OFFSET + LIMIT value ${vectorSearchBufferSize} larger than the vectorSearchBufferSize ${maxBufferSize} ` +\n          `is not allowed`,\n      );\n    }\n  }\n\n  private calculateVectorSearchBufferSize(queryInfo: QueryInfo, options: FeedOptions): number {\n    if (queryInfo.top === 0 || queryInfo.limit === 0) return 0;\n    return queryInfo.top\n      ? queryInfo.top\n      : queryInfo.limit\n        ? queryInfo.offset + queryInfo.limit\n        : options[\"vectorSearchBufferSize\"] && options[\"vectorSearchBufferSize\"] > 0\n          ? options[\"vectorSearchBufferSize\"]\n          : QueryExecution.DEFAULT_MAX_VECTOR_SEARCH_BUFFER_SIZE;\n  }\n\n  private checkQueryConstraints(queryInfo: QueryInfo): void {\n    const hasTop = queryInfo.top || queryInfo.top === 0;\n    const hasLimit = queryInfo.limit || queryInfo.limit === 0;\n    if (!hasTop && !hasLimit) {\n      throw new ErrorResponse(\n        \"Executing a non-streaming search query without TOP or LIMIT can consume a large number of RUs \" +\n          \"very fast and have long runtimes. Please ensure you are using one of the above two filters \" +\n          \"with your vector search query.\",\n      );\n    }\n    return;\n  }\n\n  /**\n   * Analyzes query information and extracts key characteristics for query execution planning\n   */\n  private analyzeQueryInfo(queryInfo: QueryInfo) {\n    const sortOrders = queryInfo.orderBy;\n    const nonStreamingOrderBy = queryInfo.hasNonStreamingOrderBy;\n    const isOrderByQuery = Array.isArray(sortOrders) && sortOrders.length > 0;\n\n    // Check if this is a GROUP BY query\n    const isGroupByQuery =\n      Object.keys(queryInfo.groupByAliasToAggregateType || {}).length > 0 ||\n      (queryInfo.aggregates?.length || 0) > 0 ||\n      (queryInfo.groupByExpressions?.length || 0) > 0;\n\n    // Check if this is an unordered DISTINCT query\n    const isUnorderedDistinctQuery = queryInfo.distinctType === \"Unordered\";\n\n    // Determine if this query type supports continuation tokens\n    const querySupportsTokens =\n      !isUnorderedDistinctQuery && !isGroupByQuery && !nonStreamingOrderBy;\n\n    return {\n      sortOrders,\n      nonStreamingOrderBy,\n      isOrderByQuery,\n      isGroupByQuery,\n      isUnorderedDistinctQuery,\n      querySupportsTokens,\n    };\n  }\n}\n"]}